<?php

namespace Tests\Unit\CompressedLink;

use App\Links\CompressedLink;
use App\User;
use Illuminate\Foundation\Testing\DatabaseTransactions;
use Illuminate\Http\Response;
use Illuminate\Support\Collection;
use Tests\TestCase;

class LinksControllerTest extends TestCase
{
    use DatabaseTransactions;

    /**
     * @var Collection
     */
    private $links;

    /**
     * @var User
     */
    private $user;

    /**
     * @var User
     */
    private $wrongUser;

    /**
     * @var Collection
     */
    private $wrongLinks;

    protected function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        $this->user = factory(User::class)->create();
        $this->wrongUser = factory(User::class)->create();
        $this->actingAs($this->user);
        $this->links = factory(CompressedLink::class, 3)->make()->each(function (CompressedLink $link) {
            $link->user()->associate($this->user)->save();
        });

        $this->wrongLinks = factory(CompressedLink::class, 3)->make()->each(function (CompressedLink $link) {
            $link->user()->associate($this->wrongUser)->save();
        });

    }

    public function testIndex()
    {
        $response = $this->get('/links');
        $response->assertOk();
        $payload = $response->decodeResponseJson()['data'];
        $this->assertEquals($this->links->count(), count($payload));
    }

    public function testGet()
    {
        $response = $this->get('/links/' . $this->links->first()->id);
        $response->assertOk();
        $payload = $response->decodeResponseJson()['data'];
        $this->assertEquals($this->links->first()->link, $payload['link']);
    }

    public function testPost()
    {
        $response = $this->post('/links', ['link' => 'testword']);
        $this->assertEquals(Response::HTTP_CREATED, $response->getStatusCode());
    }

    public function testPut()
    {
        $updateValue = 'testword';
        $response = $this->get('/links/' . $this->links->first()->id);
        $response->assertOk();
        $link = $response->decodeResponseJson()['data'];
        $link['link'] = $updateValue;

        $response = $this->put('/links/' . $this->links->first()->id, $link);
        $response->assertOk();
        $link = $response->decodeResponseJson()['data'];
        $this->assertEquals($updateValue, $link['link']);
    }

    public function testDelete()
    {
        $response = $this->delete('/links/' . $this->links->first()->id);
        $response->assertOk();

        $response = $this->get('/links/' . $this->links->first()->id);
        $this->assertEquals(Response::HTTP_NOT_FOUND, $response->getStatusCode());
    }

    public function testWrongGet()
    {
        $response = $this->get('/links/' . ($this->links->first()->id + 1000));
        $this->assertEquals(Response::HTTP_NOT_FOUND, $response->getStatusCode());
    }

    public function testWrongPost()
    {
        $response = $this->post('/links', ['link' => str_repeat('testword', 1000)]);
        $this->assertEquals(Response::HTTP_BAD_REQUEST, $response->getStatusCode());
    }

    public function testWrongPut()
    {
        $updateValue = str_repeat('testword', 1000);
        $response = $this->get('/links/' . $this->links->first()->id);
        $response->assertOk();
        $link = $response->decodeResponseJson()['data'];
        $link['link'] = $updateValue;

        $response = $this->put('/links/' . $this->links->first()->id, $link);
        $this->assertEquals(Response::HTTP_BAD_REQUEST, $response->getStatusCode());
    }

    public function testWrongDelete()
    {
        $response = $this->delete('/links/' . ($this->links->first()->id + 1000));
        $this->assertEquals(Response::HTTP_NOT_FOUND, $response->getStatusCode());
    }

}
